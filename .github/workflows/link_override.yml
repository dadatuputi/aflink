name: Link Override from Issue

on:
  repository_dispatch:
    types: [link_override]
  
jobs:
  override_link:
    runs-on: ubuntu-latest
    steps:
      
    - name: parse_fields
      env:
        BODY: ${{ github.event.client_payload.issue_body }}
      run: |

        echo "Original issue: ${{ github.event.client_payload.original_issue }}"
        echo "Triggered by: ${{ github.event.client_payload.triggered_by }}"
        echo "Issue body: ${{ github.event.client_payload.issue_body }}"
         
        # Parse the override issue body format (Issue template now supplies Link ID)
        LINK_ID=$(echo "$BODY" | grep -A2 "### Link ID" | tail -n1 | xargs)
        NEW_TITLE=$(echo "$BODY" | grep -A2 "### Link Title" | tail -n1 | xargs)
        NEW_LINK=$(echo "$BODY" | grep -A2 "### Link URL" | tail -n1 | xargs)

        # Validate required fields
        if [[ -z "$LINK_ID" ]]; then
          echo "VALIDATION_ERROR=Missing link id" >> $GITHUB_ENV
          exit 1
        fi

        # Export to environment
        echo "LINK_ID=$LINK_ID" >> $GITHUB_ENV
        echo "NEW_TITLE=$NEW_TITLE" >> $GITHUB_ENV
        echo "NEW_LINK=$NEW_LINK" >> $GITHUB_ENV

        # If both title and link are empty, mark validation error for a later step to comment + fail
        if [[ -z "$NEW_TITLE" && -z "$NEW_LINK" ]]; then
          echo "VALIDATION_ERROR=Missing both title and url" >> $GITHUB_ENV
        fi

        echo "✅ Parsed values:"
        echo "  Link ID: $LINK_ID"
        echo "  New Title: $NEW_TITLE"
        echo "  New URL: $NEW_LINK"
          
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install jq & sponge
      run: |
        # Skip installing pacakge docs {makes the man-db trigger much faster) 
        # disabled `/doc` and `/info` as well to speed up apt operations further
        sudo tee /etc/dpkg/dpkg.cfg.d/01_nodoc > /dev/null << 'EOF'
        path-exclude /usr/share/doc/*
        path-exclude /usr/share/man/*
        path-exclude /usr/share/info/*
        EOF

        sudo apt-get update
        sudo apt-get install --yes jq moreutils uuid-runtime

    - name: Fail if no link and no url provided
      if: env.VALIDATION_ERROR != ''
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.createComment({
            issue_number: context.payload.client_payload.original_issue,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `❌ Failed to add override: no Link Title or Link URL provided. Please include at least one of 'Link Title' or 'Link URL' in the issue body so the override can be created.`
          });
          throw new Error('Validation error: missing title and url');
        
    - name: Determine target for override/update
      run: |
        echo "Searching for LINK_ID: $LINK_ID"

        # Look in links_other.json for a contentId match
        if jq -e --arg id "$LINK_ID" '.OTHER[]? | select(.contentId == $id)' src/links/links_other.json >/dev/null 2>&1; then
          echo "FOUND_IN=links_other.json" >> $GITHUB_ENV
          echo "ACTION=edit_other" >> $GITHUB_ENV
          echo "Found in src/links/links_other.json; will update that file."

        # Else look in links_af.json for a contentId match
        elif jq -e --arg id "$LINK_ID" '.afpCategorizedLinksDto.links[]? | .[]? | select(.contentId == $id)' src/links/links_af.json >/dev/null 2>&1; then
          echo "FOUND_IN=links_af.json" >> $GITHUB_ENV
          echo "ACTION=override" >> $GITHUB_ENV
          echo "Found in src/links/links_af.json; will add override entry."

        else
          echo "FOUND_IN=none" >> $GITHUB_ENV
          echo "ACTION=none" >> $GITHUB_ENV
          echo "Error: LINK_ID '$LINK_ID' not found in either links_other.json or links_af.json"
          exit 1
        fi

    - name: Update entry in links_other.json
      if: env.ACTION == 'edit_other'
      run: |
        set -o pipefail
        jq -r --arg id "${{ env.LINK_ID }}" \
           --arg NEW_TITLE "${{ env.NEW_TITLE }}" \
           --arg NEW_LINK "${{ env.NEW_LINK }}" \
           '.OTHER |= map( if .contentId == $id then
               .title = (if $NEW_TITLE == "" or $NEW_TITLE == "null" or $NEW_TITLE == "_No response_" then null else $NEW_TITLE end) |
               .link = (if $NEW_LINK == "" or $NEW_LINK == "null" or $NEW_LINK == "_No response_" then null else $NEW_LINK end)
             else . end )' src/links/links_other.json | sponge src/links/links_other.json

        echo "✅ Updated src/links/links_other.json for LINK_ID '${{ env.LINK_ID }}'"

    - name: Add override to file (for links_af.json)
      if: env.ACTION == 'override'
      run: |
        set -o pipefail
        OVERRIDE_ID=$(uuidgen)

        # Add override entry to flat JSON array (handle null values properly)
        jq --arg LINK_ID "${{ env.LINK_ID }}" \
           --arg NEW_TITLE "${{ env.NEW_TITLE }}" \
           --arg NEW_LINK "${{ env.NEW_LINK }}" \
           --arg OVERRIDE_ID "$OVERRIDE_ID" \
           '. += [{
             "id": $OVERRIDE_ID,
             "match_method": "Content ID",
             "match": $LINK_ID,
             "title": (if $NEW_TITLE == "" or $NEW_TITLE == "null" or $NEW_TITLE == "_No response_" then null else $NEW_TITLE end),
             "link": (if $NEW_LINK == "" or $NEW_LINK == "null" or $NEW_LINK == "_No response_" then null else $NEW_LINK end),
             "timestamp": now
           }]' src/links/links_override.json | sponge src/links/links_override.json

        echo "✅ Override added to links_override.json"
        
    - name: Commit New Changes
      uses: EndBug/add-and-commit@v9
      with:
        message: "Override or update link from issue: ${{ env.LINK_ID }}"

    - name: Trigger next workflow
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.repos.createDispatchEvent({
            owner: context.repo.owner,
            repo: context.repo.repo,
            event_type: 'build',
            client_payload: {
              commit_sha: context.sha,
              message: 'Updated links from Issue'
            }
          });
        
    - name: Add success comment
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.createComment({
            issue_number: context.payload.client_payload.original_issue,
            owner: context.payload.client_payload.triggered_by,
            repo: context.repo.repo,
            body: `✅ **Link updated successfully!** 
            
            The link "${{ env.LINK_ID }}" has been updated and will be active on the next site deployment.
            
            **Update Details:**
            - Link ID: ${{ env.LINK_ID }}
            - New Title: ${{ env.NEW_TITLE }}
            - New URL: ${{ env.NEW_LINK }}`
          })
